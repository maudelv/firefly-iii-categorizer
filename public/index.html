<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>FireflyService III AI Categorizer</title>
    <style>
        body {
            font-family: sans-serif;
            background: lightgray;
        }

        .container {
            max-width: max(80%, 1024px);
            margin: 5% auto;
            padding: 24px;
            background: #FFF;
            border-radius: 5px;
            box-shadow: 0 0 5px rgba(0, 0, 0, .25);
        }

        h1 {
            text-align: center;
        }

        .transactions-panel {
            margin-bottom: 2em;
        }

        .transactions-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
            margin-bottom: 12px;
        }

        .transactions-controls label {
            font-size: 0.9em;
        }

        .transactions-controls input {
            width: 4.5em;
        }

        .transactions-table-wrapper {
            overflow-x: auto;
        }

        .transactions-table {
            width: 100%;
            border-collapse: collapse;
        }

        .transactions-table th,
        .transactions-table td {
            text-align: left;
            padding: 6px 8px;
            border-bottom: 1px solid #ddd;
        }

        .transactions-table td.actions {
            text-align: center;
        }

        .transactions-status {
            font-size: 0.9em;
            color: #555;
        }

        .transactions-notice {
            display: none;
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .transactions-notice.success {
            background: #e8f5e9;
            border: 1px solid #a5d6a7;
            color: #1b5e20;
        }

        .transactions-notice.error {
            background: #ffebee;
            border: 1px solid #ef9a9a;
            color: #b71c1c;
        }

        .job {
            border: solid 1px;
            border-radius: 5px;
            margin-bottom: 2em;
            padding: 24px;
        }

        pre {
            padding: 7px;
            background: #eeeeee;
            overflow-x: auto;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Firefly III AI Categorizer</h1>
    <section class="transactions-panel">
        <h2>Transacciones</h2>
        <div class="transactions-controls">
            <label>
                Límite
                <input type="number" id="tx-limit" min="1" max="100" value="10">
            </label>
            <label>
                Página
                <input type="number" id="tx-page" min="1" value="1">
            </label>
            <button type="button" id="tx-prev">Anterior</button>
            <button type="button" id="tx-next">Siguiente</button>
            <button type="button" id="tx-refresh">Actualizar</button>
            <button type="button" id="tx-batch" disabled>Clasificar elegibles</button>
            <span id="tx-status" class="transactions-status" aria-live="polite"></span>
        </div>
        <div id="tx-notice" class="transactions-notice" aria-live="polite"></div>
        <div class="transactions-table-wrapper">
            <table class="transactions-table">
                <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Descripción</th>
                    <th>Importe</th>
                    <th>Moneda</th>
                    <th>Categoría</th>
                    <th>Desde</th>
                    <th>Hacia</th>
                    <th>Acciones</th>
                </tr>
                </thead>
                <tbody id="tx-table-body">
                <tr>
                    <td colspan="8">Sin transacciones cargadas.</td>
                </tr>
                </tbody>
            </table>
        </div>
    </section>
    <section>
        <h2>Jobs</h2>
        <div id="mount"></div>
<!--        <article class="job">-->
<!--            <div><strong>Status:</strong> <span>queued</span></div>-->
<!--            <div><strong>Created:</strong>-->
<!--                <time>2023-05-21 15:50:00</time>-->
<!--            </div>-->
<!--            <div><strong>Webhook UUID:</strong> <span>34zrurjd-44df-we4dtfds</span></div>-->
<!--            <div><strong>Destination name:</strong> <span>LIEFERANDO.DE LIEFERSERVI</span></div>-->
<!--            <div><strong>Description:</strong> <span>LIEFERANDO.DE LIEFERSERVI; AMSTERDAM NL; KARTE 8338; 40010075001 16052023; KDN-REF 000000986464</span>-->
<!--            </div>-->
<!--            <div><strong>Prompt:</strong><br>-->
<!--                <pre>Given i want to categorize transactions on my bank account into this categories: Bargeld, Gas, Haushalt, Kino, Lebensmittel, Lieferdienst, ÖPNV, Restaurants, Rundfunkbeitrag, Strom-->
<!--In which category would a transaction from "LIEFERANDO.DE LIEFERSERVI" with the subject "LIEFERANDO.DE LIEFERSERVI; AMSTERDAM NL; KARTE 8338; 40010075001 16052023; KDN-REF 000000986464" fall into?-->
<!--Just output the name of the category. Does not have to be a complete sentence.</pre>-->
<!--            </div>-->
<!--            <div><strong>Open AI's guess:</strong><br>-->
<!--                <pre>-->
<!--Lieferdienst-->
<!--</pre>-->
<!--            </div>-->
<!--        </article>-->
    </section>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    const txState = {
        limit: 10,
        page: 1,
        pageCount: null,
        isLoading: false,
    };

    const txElements = {
        limitInput: document.getElementById('tx-limit'),
        pageInput: document.getElementById('tx-page'),
        prevButton: document.getElementById('tx-prev'),
        nextButton: document.getElementById('tx-next'),
        refreshButton: document.getElementById('tx-refresh'),
        status: document.getElementById('tx-status'),
        tableBody: document.getElementById('tx-table-body'),
        notice: document.getElementById('tx-notice'),
        batchButton: document.getElementById('tx-batch'),
    };

    const batchState = {
        isProcessing: false,
        eligibleIds: [],
    };

    initTransactionsPanel();

    let socket = io();

    const mount = document.getElementById('mount');

    socket.on('jobs', jobs => {
        console.log('jobs', jobs);

        jobs.sort((a, b) => {
            return new Date(b.created) - new Date(a.created);
        })

        jobs.forEach(job => {
            const element = document.createElement('div');
            element.innerHTML = renderJob(job);
            mount.appendChild(element)
        });
    });

    socket.on('job created', e => {
        console.log('job created', e);
        const element = document.createElement('div');
        element.innerHTML = renderJob(e.job);
        mount.prepend(element);
    })

    socket.on('job updated', e => {
        console.log('job updated', e)

        const element = document.createElement('div');
        element.innerHTML = renderJob(e.job);

        const oldElement = document.querySelector(`[data-job-id="${e.job.id}"]`);
        oldElement.before(element);
        oldElement.remove();
    })

    const renderJob = (job) => {
        return `<article class="job" data-job-id="${job.id}">
            <div><strong>ID:</strong> <span>${job.id}</span></div>
            <div><strong>Status:</strong> <span>${job.status}</span></div>
            <div><strong>Created:</strong>
                <time>${Intl.DateTimeFormat(undefined, {
            dateStyle: 'medium',
            timeStyle: 'medium'
        }).format(new Date(job.created))}</time>
            </div>
            <div><strong>Destination name:</strong> <span>${job.data?.destinationName || ''}</span></div>
            <div><strong>Description:</strong> <span>${job.data?.description || ''}</span>
            <div><strong>Guessed category:</strong> <span>${job.data?.category ? job.data.category : '<em>Not yet classified</em>'}</span>
            </div>
            ${ job.data?.expenseAccount ? `<div><strong>Expense Account:</strong> <span>${escapeHtml(job.data.expenseAccount.name)} (${escapeHtml(job.data.expenseAccount.action)})</span><br>
                <details>
                    <summary>Description</summary>
                    <p>${escapeHtml(job.data.expenseAccount.description)}</p>
                </details>
            </div>` : ''}
            ${ job.data?.prompt ? `<div><strong>Prompt:</strong><br>
                <details>
                    <summary>Show</summary>
                    <pre>${escapeHtml(job.data.prompt)}</pre>
                </details>
            </div>` : ''}
            ${ job.data?.response ? `<div><strong>Open AI's response:</strong>
                 <details>
                    <summary>Show</summary>
                    <pre>${escapeHtml(job.data.response)}</pre>
                 </details>
            </div>` : ''}
        </article>`
    }

    function initTransactionsPanel() {
        const {limitInput, pageInput, prevButton, nextButton, refreshButton, tableBody, batchButton} = txElements;
        if (!limitInput || !pageInput || !prevButton || !nextButton || !refreshButton || !tableBody || !batchButton) {
            return;
        }

        limitInput.value = txState.limit;
        pageInput.value = txState.page;

        limitInput.addEventListener('change', () => {
            const nextLimit = Number.parseInt(limitInput.value, 10);
            txState.limit = Number.isNaN(nextLimit) || nextLimit <= 0 ? 10 : nextLimit;
            limitInput.value = txState.limit;
            txState.page = 1;
            pageInput.value = txState.page;
            loadTransactions();
        });

        pageInput.addEventListener('change', () => {
            const nextPage = Number.parseInt(pageInput.value, 10);
            txState.page = Number.isNaN(nextPage) || nextPage <= 0 ? 1 : nextPage;
            pageInput.value = txState.page;
            loadTransactions();
        });

        prevButton.addEventListener('click', () => {
            if (txState.page <= 1 || txState.isLoading) {
                return;
            }
            txState.page -= 1;
            pageInput.value = txState.page;
            loadTransactions();
        });

        nextButton.addEventListener('click', () => {
            if (txState.isLoading) {
                return;
            }
            if (txState.pageCount != null && txState.page >= txState.pageCount) {
                return;
            }
            txState.page += 1;
            pageInput.value = txState.page;
            loadTransactions();
        });

        refreshButton.addEventListener('click', () => {
            if (!txState.isLoading) {
                loadTransactions();
            }
        });

        batchButton.addEventListener('click', onBatchClassifyClick);

        tableBody.addEventListener('click', onTransactionTableClick);

        updateNavState();
        updateBatchButton();
        loadTransactions();
    }

    async function loadTransactions() {
        const params = new URLSearchParams({
            limit: txState.limit,
            page: txState.page
        });

        batchState.eligibleIds = [];
        txState.isLoading = true;
        updateNavState();
        setStatus('Cargando…');
        clearNotice();

        try {
            const response = await fetch(`/api/transactions?${params.toString()}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const payload = await response.json();
            const items = Array.isArray(payload?.items) ? payload.items : [];
            txState.pageCount = payload?.pagination?.pageCount ?? null;

            renderTransactions(items);

            const countLabel = items.length === 1 ? '1 resultado' : `${items.length} resultados`;
            setStatus(countLabel);
        } catch (error) {
            console.error(error);
            txState.pageCount = null;
            renderTransactions([]);
            setStatus('Error al cargar transacciones');
            setNotice('No se pudieron cargar las transacciones.', 'error');
        } finally {
            txState.isLoading = false;
            updateNavState();
            updateBatchButton();
        }
    }

    function renderTransactions(items) {
        const body = txElements.tableBody;
        if (!body) {
            return;
        }

        const eligibleSet = new Set();

        if (!items || items.length === 0) {
            body.innerHTML = '<tr><td colspan="8">No hay transacciones para mostrar.</td></tr>';
            batchState.eligibleIds = [];
            updateBatchButton();
            return;
        }

        const rows = items.map(item => {
            const journalId = item.journalId ?? item.id ?? '';
            const canClassify = !!journalId && (item.type ?? '').toLowerCase() === 'withdrawal' && item.category_id == null && !!item.destination_name;

            if (canClassify) {
                eligibleSet.add(String(journalId));
            }

            return `<tr>
                <td>${formatDate(item.date)}</td>
                <td>${escapeHtml(item.type ?? '')}</td>
                <td>${escapeHtml(item.description ?? '')}</td>
                <td>${escapeHtml(formatAmount(item.amount))}</td>
                <td>${escapeHtml(item.currency ?? '')}</td>
                <td>${escapeHtml(item.category_name ?? '')}</td>
                <td>${escapeHtml(item.source_name ?? '')}</td>
                <td>${escapeHtml(item.destination_name ?? '')}</td>
                <td class="actions">${renderActionCell(journalId, canClassify)}</td>
            </tr>`;
        });

        body.innerHTML = rows.join('');
        batchState.eligibleIds = Array.from(eligibleSet);
        updateBatchButton();
    }

    function renderActionCell(journalId, canClassify) {
        if (!journalId) {
            return '<span>—</span>';
        }

        if (!canClassify) {
            return '<button type="button" disabled>No disponible</button>';
        }

        return `<button type="button" class="tx-classify" data-journal-id="${escapeHtml(String(journalId))}">Clasificar</button>`;
    }

    function onTransactionTableClick(event) {
        const button = event.target.closest('.tx-classify');
        if (!button || button.disabled) {
            return;
        }

        const journalId = button.getAttribute('data-journal-id');
        if (!journalId) {
            return;
        }

        classifyTransaction(journalId, button);
    }

    async function classifyTransaction(journalId, button) {
        try {
            button.disabled = true;
            button.textContent = 'Enviando…';

            const response = await fetch('/api/classify', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({transactionId: journalId})
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            button.textContent = 'En cola';
            setNotice('Clasificación encolada.', 'success');
            await loadTransactions();
        } catch (error) {
            console.error(error);
            button.disabled = false;
            button.textContent = 'Clasificar';
            setNotice('No se pudo iniciar la clasificación.', 'error');
        }
    }

    async function onBatchClassifyClick() {
        if (batchState.isProcessing || batchState.eligibleIds.length === 0) {
            return;
        }

        batchState.isProcessing = true;
        updateBatchButton();
        setNotice('Enviando lote…');

        try {
            const response = await fetch('/api/classify/batch', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({transactionIds: batchState.eligibleIds})
            });

            const contentType = response.headers.get('content-type') ?? '';
            let payload = null;
            if (contentType.includes('application/json')) {
                payload = await response.json();
            }
            payload = payload ?? {};

            if (!response.ok) {
                const message = payload?.errors?.[0]?.message ?? payload?.message ?? 'No se pudieron encolar las transacciones.';
                setNotice(message, 'error');
                return;
            }

            const queuedCount = Array.isArray(payload?.jobs) ? payload.jobs.length : 0;
            const errorCount = Array.isArray(payload?.errors) ? payload.errors.length : 0;

            if (errorCount > 0) {
                const parts = [];
                if (queuedCount > 0) {
                    parts.push(queuedCount === 1 ? '1 transacción encolada.' : `${queuedCount} transacciones encoladas.`);
                }
                parts.push(errorCount === 1 ? '1 transacción no se pudo encolar.' : `${errorCount} transacciones no se pudieron encolar.`);
                setNotice(parts.join(' '), 'error');
            } else if (queuedCount > 0) {
                const successMessage = queuedCount === 1 ? '1 transacción encolada.' : `${queuedCount} transacciones encoladas.`;
                setNotice(successMessage, 'success');
            } else {
                setNotice('No se encoló ninguna transacción.', 'error');
            }

            await loadTransactions();
        } catch (error) {
            console.error(error);
            setNotice('No se pudieron encolar las transacciones.', 'error');
        } finally {
            batchState.isProcessing = false;
            updateBatchButton();
        }
    }

    function setStatus(message) {
        if (txElements.status) {
            txElements.status.textContent = message ?? '';
        }
    }

    function setNotice(message, type = 'info') {
        const el = txElements.notice;
        if (!el) {
            return;
        }

        clearTimeout(el._hideTimer);
        el.textContent = message ?? '';
        el.classList.remove('success', 'error');

        if (!message) {
            el.style.display = 'none';
            return;
        }

        if (type === 'success') {
            el.classList.add('success');
        } else if (type === 'error') {
            el.classList.add('error');
        }

        el.style.display = 'block';

        clearTimeout(el._hideTimer);
        el._hideTimer = setTimeout(() => {
            el.style.display = 'none';
        }, 2500);
    }

    function clearNotice() {
        setNotice('');
    }

    function updateNavState() {
        const {prevButton, nextButton, limitInput, pageInput, refreshButton} = txElements;

        if (prevButton) {
            prevButton.disabled = txState.isLoading || txState.page <= 1;
        }
        if (nextButton) {
            const atEnd = txState.pageCount != null && txState.page >= txState.pageCount;
            nextButton.disabled = txState.isLoading || atEnd;
        }
        if (limitInput) {
            limitInput.disabled = txState.isLoading;
        }
        if (pageInput) {
            pageInput.disabled = txState.isLoading;
        }
        if (refreshButton) {
            refreshButton.disabled = txState.isLoading;
        }

        updateBatchButton();
    }

    function updateBatchButton() {
        const button = txElements.batchButton;
        if (!button) {
            return;
        }

        const count = batchState.eligibleIds.length;
        if (batchState.isProcessing) {
            button.textContent = 'Enviando…';
        } else if (count > 0) {
            button.textContent = `Clasificar elegibles (${count})`;
        } else {
            button.textContent = 'Clasificar elegibles';
        }

        button.disabled = txState.isLoading || batchState.isProcessing || count === 0;
    }

    function formatDate(value) {
        if (!value) {
            return '';
        }

        const date = new Date(value);
        if (Number.isNaN(date.getTime())) {
            return escapeHtml(String(value));
        }

        return Intl.DateTimeFormat(undefined, {
            dateStyle: 'medium',
        }).format(date);
    }

    function formatAmount(amount) {
        if (amount == null) {
            return '';
        }
        return String(amount);
    }

    function escapeHtml(value) {
        return String(value)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }
</script>
</body>
</html>
